<html>
<head>
    <meta charset="utf-8">
    <title>薪酬计算</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="/static/js/common.js"></script>
    <link rel="stylesheet" href="/static/style/admin.css" media="all">
</head>
<body>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">

        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">批量导入</div>
                <div class="layui-card-body">

                    <div class="layui-carousel layadmin-carousel layadmin-shortcut">
                        <div carousel-item>
                            <ul class="layui-row layui-col-space10">

                                <li class="layui-col-xs3 ">
                                    <a lay-href="">
                                        <i class="layui-icon  layui-btn layui-icon-template-1"
                                           id="importCheckinginID"></i>
                                        <cite>导入考勤</cite>
                                    </a>
                                </li>

                                <li class="layui-col-xs3">
                                    <a lay-href="">
                                        <i class="layui-icon layui-icon-user" id="importSecurityFundID"></i>
                                        <cite>导入社保公积金</cite>
                                    </a>
                                </li>

                                <li class="layui-col-xs3 ">
                                    <a lay-href="">
                                        <i class="layui-icon  layui-btn layui-icon-template-1" id="importPaymentID"></i>
                                        <cite>导入补款扣款项</cite>
                                    </a>
                                </li>

                                <li class="layui-col-xs3 ">
                                    <a lay-href="">
                                        <i class="layui-icon  layui-btn layui-icon-template-1"
                                           id="trialCountID"></i>
                                        <cite>试算</cite>
                                    </a>
                                </li>


                                <li class="layui-col-xs3">
                                    <a lay-href="">
                                        <i class="layui-icon layui-icon-set" id="importImportHistoryEmpID"></i>
                                        <cite>历史薪资导入</cite>
                                    </a>
                                </li>
                                <li class="layui-col-xs3">
                                    <a lay-href="">
                                        <i class="layui-icon layui-icon-set" id="importTotalDataID"></i>
                                        <cite>累计数据导入</cite>
                                    </a>
                                </li>
                                <li class="layui-col-xs3 ">
                                    <a href="/static/template/salaryTemplate.rar">
                                        <i class="layui-icon layui-icon-survey" id="downloadTemplateID"></i>
                                        <cite>模板下载</cite>
                                    </a>
                                </li>
                                <li class="layui-col-xs3 ">
                                    <a lay-href="">
                                        <i class="layui-icon  layui-btn layui-icon-template-1"
                                           id="sencondCountID"></i>
                                        <cite>重算</cite>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">汇总统计</div>
                <div class="layui-card-body">

                    <div class="layui-carousel layadmin-carousel layadmin-backlog">
                        <div carousel-item>
                            <ul class="layui-row layui-col-space10">
                                <li class="layui-col-xs6">
                                    <a lay-href="app/content/comment.html" class="layadmin-backlog-body">
                                        <h3>在职</h3>
                                        <p><cite>{{.OnTheJob}}</cite></p>
                                    </a>

                                </li>
                                <li class="layui-col-xs6">
                                    <a lay-href="app/forum/list.html" class="layadmin-backlog-body">
                                        <h3>离职</h3>
                                        <p><cite>{{.LeaveJob}}</cite></p>
                                    </a>
                                </li>
                                <li class="layui-col-xs6">
                                    <a lay-href="template/goodslist.html" class="layadmin-backlog-body">
                                        <h3>入职</h3>
                                        <p><cite>{{.GetIn}}</cite></p>
                                    </a>
                                </li>
                                <li class="layui-col-xs6">
                                    <a href="javascript:;" onclick="layer.tips('不跳转', this, {tips: 3});"
                                       class="layadmin-backlog-body">
                                        <h3>转正</h3>
                                        <p><cite>{{.ChangeFormal}}</cite></p>
                                    </a>
                                </li>
                                <li class="layui-col-xs6">
                                    <a href="javascript:;" onclick="layer.tips('不跳转', this, {tips: 3});"
                                       class="layadmin-backlog-body">
                                        <h3>调薪</h3>
                                        <p><cite>{{.ChangeSalary}}</cite></p>
                                    </a>
                                </li>
                                <li class="layui-col-xs6">
                                    <a href="javascript:;" onclick="layer.tips('不跳转', this, {tips: 3});"
                                       class="layadmin-backlog-body">
                                        <h3>调岗</h3>
                                        <p><cite>{{.ChangeJob}}</cite></p>
                                    </a>
                                </li>
                                <li class="layui-col-xs6">
                                    <a href="javascript:;" onclick="layer.tips('不跳转', this, {tips: 3});"
                                       class="layadmin-backlog-body">
                                        <h3>待入职</h3>
                                        <p><cite>{{.WaitForJob}}</cite></p>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-form">
        <div class="layui-form-item">
            <div class="layui-form">
                <div class="layui-inline">
                    <label class="layui-form-label">查询时间：</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" id="dateRange" placeholder="起始年月  -  结束年月">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 薪酬计算 -->
    <table class="layui-hide" id="calculationSalaryID" lay-filter="tableFilter"></table>
    <script type="text/html" id="tableBarID">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>

    <script src="/static/layui/layui.js?t=1"></script>
    <script>

        layui.config({
            base: '/static/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use(['index', 'console']);

        layui.use(['laydate','form', 'element', 'upload', 'table'], function () {
            var form = layui.form
                    , $ = layui.jquery
                    , element = layui.element
                    , table = layui.table
                    , laypage = layui.laypage //分页
                    , laydate = layui.laydate
                    , upload = layui.upload;

            var $ = layui.$, active = {
                reload: function () {
                    var demoReload = $('#tableReload');

                    //执行重载
                    table.reload('testReload', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                        , where: {
                            key: {
                                id: demoReload.val()
                            }
                        }
                    }, 'data');
                }
            };


            /** 1. 导入考勤  **/
            upload.render({
                elem: '#importCheckinginID' //绑定元素
                , url: '/salary/upload/' //上传接口
                , data : {
                    salarytype : "now"
                }
                , exts:'xls|xlsx|txt'
                , done: function (res) {
                    if (-1 === res.status  || -1 === res.code) {
                        layer.alert(res.msg);
                        return;
                    }
                    layer.msg('上传成功');
                }
                , error: function () {
                    layer.alert(res.msg);
                    //请求异常回调
                }
            });

            /** 2. 导入社保公积金  **/
            upload.render({
                elem: '#importSecurityFundID' //绑定元素
                , url: '/salary/upload/' //上传接口
                , data : {
                    salarytype : "fund"
                }
                , exts:'xls|xlsx|txt'
                , done: function (res) {
                    if (-1 === res.status  || -1 === res.code) {
                        layer.alert(res.msg);
                        return;
                    }
                    layer.msg('上传成功');
                }
                , error: function () {
                    layer.alert(res.msg);
                    //请求异常回调
                }
            });

            /** 3. 导入补款扣款项  **/
            upload.render({
                elem: '#importPaymentID' //绑定元素
                , url: '/salary/upload/' //上传接口
                , data : {
                    salarytype : "add"
                }
                , exts:'xls|xlsx|txt'
                , done: function (res) {
                    if (-1 === res.status  || -1 === res.code) {
                        layer.alert(res.msg);
                        return;
                    }
                    layer.msg('上传成功');
                }
                , error: function () {
                    layer.alert(res.msg);
                    //请求异常回调
                }
            });

            /** 4. 试算  **/
            $('#trialCountID').on('click', function(){
                $.ajax({
                    url:'/salary/calc/',
                    type:'post',
                    success:function(data){
                        layer.alert(data.msg);
                        table.reload('tableOne', {
                            method: 'post'
                            , page: {
                                curr: 1
                            }
                        });
                    },
                });
            });
            /** 4. 重算  **/
            $('#sencondCountID').on('click', function(){
                $.ajax({
                    url:'/salary/again/',
                    type:'post',
                    success:function(data){
                        layer.alert(data.msg);
                        table.reload('tableOne', {
                            method: 'post'
                            , page: {
                                curr: 1
                            }
                        });
                    },
                });
            });

            /** 5. 历史薪资导入  **/
            upload.render({
                elem: '#importImportHistoryEmpID' //绑定元素
                , url: '/salary/upload/' //上传接口
                , data : {
                    salarytype : "history"
                }
                , exts:'xls|xlsx|txt'
                , done: function (res) {
                    if (0 !== res.status   || -1 === res.code) {
                        layer.msg(res.msg);
                        return;
                    }
                    layer.msg('上传成功');
                }
                , error: function () {
                    layer.alert(res.msg);
                    //请求异常回调
                }
            });

            /** 6. 累计数据导入  **/
            upload.render({
                elem: '#importTotalDataID' //绑定元素
                , url: '/salary/upload/' //上传接口
                , data : {
                    salarytype : "total"
                }
                , exts:'xls|xlsx|txt'
                , done: function (res) {
                    if (0 !== res.status  || -1 === res.code) {
                        layer.msg(res.msg);
                        return;
                    }
                }
                , error: function () {
                    layer.alert(res.msg);
                    //请求异常回调
                }
            });

            /** 计算薪酬  **/
            table.render({
                elem: '#calculationSalaryID'
                , id : 'tableOne'
                , url: '/salary/sum' //数据接口
                , title: '薪酬信息表'
                , page: true //开启分页
                , toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
                , cols: [[ //表头
                    {type: 'checkbox', fixed: 'left'}
                    , {field: 'calc_month',              title: '月份',            sort: true }
                    , {field: 'total_pay_peaple',        title: '发薪人数',        sort: true }
                    , {field: 'sum_pay_fix',             title: '固定工资合计',    sort: true }
                    , {field: 'pay_bonus',               title: '绩效合计',        sort: true }
                    , {field: 'sum_pay_before_tax',      title: '应发合计',        sort: true }
                    , {field: 'sum_fund',                title: '个人社保合计',    sort: true }
                    , {field: 'sum_social',              title: '个人公积金合计',  sort: true }
                    , {field: 'sum_tax_should',          title: '个税合计',        sort: true }
                    , {field: 'fact_pay',                title: '实发合计',        sort: true }
                    , {field: 'sum_company_fund',        title: '公司公积金合计',  sort: true }
                    , {field: 'sum_company_social',      title: '公司社保合计',    sort: true }
                    , {field: 'sum_company_cost',        title: '人力成本合计',    sort: true }
                    , {field: 'whether_show_report',     title: '是否展示报表',    sort: true }
                    , {fixed: 'right',                   title: '操作',            width: 180,align: 'center', toolbar: '#tableBarID'}
                ]]
            });

            /** 监听行工具事件 (右侧) **/
            table.on('tool(tableFilter)', function (obj) {
                var  data = obj.data                  //  获得当前行数据
                        , layEvent = obj.event;           //  获得 lay-event 对应的值

                if (layEvent === 'detail') {
                    layer.alert("<pre>" + JSON.stringify(data, null, 4) + "</pre>", {
                        title: '薪酬信息详情'
                    })
                } else if (layEvent === 'del') {
                    layer.confirm('确定删除吗', function (index) {
                        $.ajax({
                            url: '/salary/delete?id=' + data.id,
                            type: 'delete',
                            success: function (result) {
                                layer.alert('删除失败, 请重试！');
                                layer.close(index);
                                /* layer.msg('删除成功');
                                 obj.del();
                                 layer.close(index);*/
                            },
                            error: function () {
                                layer.alert('删除失败, 请重试！');
                                layer.close(index);
                            }
                        });
                    });
                }
            });

            /** 日期时间范围 **/
            laydate.render({
                elem: '#dateRange'
                , range: true
                , type: 'month'
                , theme: '#393D49'
                , done: function(date){
                    table.reload('tableOne', {
                        method: 'post'
                        , where: {
                            'selectTime': date
                        }
                        , page: {
                            curr: 1
                        }
                    });

                }
            });

            //触发事件
            var active = {
                tabAdd: function () {
                    //新增一个Tab项
                    element.tabAdd('demo', {
                        title: '新选项' + (Math.random() * 1000 | 0) //用于演示
                        , content: '内容' + (Math.random() * 1000 | 0)
                        , id: new Date().getTime() //实际使用一般是规定好的id，这里以时间戳模拟下
                    })
                }
                , tabDelete: function (othis) {
                    //删除指定Tab项
                    element.tabDelete('demo', '44'); //删除：“商品管理”


                    othis.addClass('layui-btn-disabled');
                }
                , tabChange: function () {
                    //切换到指定Tab项
                    element.tabChange('demo', '22'); //切换到：用户管理
                }
            };

            $('.site-demo-active').on('click', function () {
                var othis = $(this), type = othis.data('type');
                active[type] ? active[type].call(this, othis) : '';
            });

            //Hash地址的定位
            var layid = location.hash.replace(/^#test=/, '');
            element.tabChange('test', layid);

            element.on('tab(test)', function (elem) {
                location.hash = 'test=' + $(this).attr('lay-id');
            });

        });
    </script>
</body>
</html>

